<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Formulario con Ruleta PD</title>
  <style>
    body {
      font-family: 'Arial', sans-serif;
      text-align: center;
      padding: 20px;
      background-color: #ffe6f0;
      margin: 0;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: center;
    }
    .container {
      max-width: 500px;
      width: 100%;
    }
    h2 {
      color: #d63384;
      margin-bottom: 20px;
    }
    canvas {
      border: 5px solid #d63384;
      border-radius: 50%;
      margin: 20px auto;
      background-color: #fff0f5;
      max-width: 100%;
      height: auto;
    }
    #formulario, #ruleta, #mensajeFinal {
      display: none;
      width: 100%;
    }
    #formulario {
      display: block;
      background-color: #fff0f5;
      padding: 20px;
      border-radius: 15px;
      box-shadow: 0 0 10px #ffb3d9;
      margin: 0 auto;
    }
    .form-group {
      margin-bottom: 15px;
      text-align: left;
    }
    label {
      display: block;
      margin-bottom: 5px;
      color: #d63384;
      font-weight: bold;
    }
    input, textarea {
      width: 100%;
      padding: 10px;
      border: 1px solid #ff99cc;
      border-radius: 10px;
      font-size: 16px;
      box-sizing: border-box;
    }
    button {
      padding: 12px 25px;
      font-size: 16px;
      margin-top: 10px;
      background-color: #ff69b4;
      color: white;
      border: none;
      border-radius: 10px;
      cursor: pointer;
      transition: background-color 0.3s ease;
      font-weight: bold;
    }
    button:hover {
      background-color: #ff1493;
    }
    button:disabled {
      background-color: #cccccc;
      cursor: not-allowed;
    }
    #mensajeFinal {
      background-color: #fff0f5;
      padding: 20px;
      border-radius: 15px;
      box-shadow: 0 0 10px #ffb3d9;
    }
    #mensajeFinal h3 {
      color: #c2185b;
      margin-top: 0;
    }
    @media (max-width: 500px) {
      canvas {
        width: 300px;
        height: 300px;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <h2>üíñ ¬°Participa y Gira la Ruleta PD! üíñ</h2>

    <div id="formulario">
      <div class="form-group">
        <label for="nombre">Nombre:</label>
        <input type="text" id="nombre" placeholder="Tu nombre completo" required>
      </div>
      <div class="form-group">
        <label for="telefono">Tel√©fono:</label>
        <input type="tel" id="telefono" placeholder="N√∫mero de tel√©fono" required>
      </div>
      <button id="btnEnviar" onclick="enviarFormulario()">Enviar y girar ruleta</button>
    </div>

    <div id="ruleta">
      <canvas id="canvas" width="400" height="400"></canvas><br>
      <button id="btnGirar" onclick="girarRuleta()">üéØ Girar la ruleta</button>
    </div>

    <div id="mensajeFinal"></div>
  </div>

<script>
    // Premios principales con descripciones
    const premiosPrincipales = [
      { texto: "¬°Ganaste un peluche!", color: "#FF9FF3", descripcion: "Hermoso peluche de tu personaje favorito" },
      { texto: "¬°Desayuno sorpresa!", color: "#FECA57", descripcion: "Desayuno para dos personas en un restaurante local" },
      { texto: "Bono $30.000", color: "#FF6B6B", descripcion: "Bono de $30.000 para usar en nuestras tiendas" },
      { texto: "Bono $20.000", color: "#48DBFB", descripcion: "Bono de $20.000 para usar en nuestras tiendas" },
      { texto: "Bono $10.000", color: "#1DD1A1", descripcion: "Bono de $10.000 para usar en nuestras tiendas" }
    ];

    // Mensajes para "no gan√≥" con descripciones
    const mensajesNoGano = [
      { texto: "¬°Casi ganas!", color: "#F9D5E5", descripcion: "Estuviste muy cerca, sigue intent√°ndolo" },
      { texto: "Vuelve a intentarlo", color: "#E3EAA7", descripcion: "La pr√≥xima vez podr√≠as ganar" },
      { texto: "No ganaste", color: "#FFB347", descripcion: "Gracias por participar" },
      { texto: "Hoy no es tu d√≠a", color: "#A2C8CC", descripcion: "Pero ma√±ana podr√≠as tener mejor suerte" }
    ];

    // Combinamos todos los premios
    const todosPremios = [...premiosPrincipales, ...mensajesNoGano];
    
    let startAngle = 0;
    let arc = 2 * Math.PI / todosPremios.length;
    let spinning = false;
    let premioObtenido = {};

    const canvas = document.getElementById("canvas");
    const ctx = canvas.getContext("2d");
    const btnEnviar = document.getElementById("btnEnviar");
    const btnGirar = document.getElementById("btnGirar");

    // Ajustar canvas para dispositivos m√≥viles
    function ajustarCanvas() {
      if (window.innerWidth <= 500) {
        canvas.width = 300;
        canvas.height = 300;
      } else {
        canvas.width = 400;
        canvas.height = 400;
      }
      dibujarRuleta();
    }

    window.addEventListener('resize', ajustarCanvas);
    ajustarCanvas();

    function dibujarRuleta() {
      const size = canvas.width;
      const cx = size / 2;
      const cy = size / 2;
      const radio = size / 2 - 10;

      ctx.clearRect(0, 0, size, size);
      
      for (let i = 0; i < todosPremios.length; i++) {
        const angle = startAngle + i * arc;
        ctx.beginPath();
        ctx.fillStyle = todosPremios[i].color;
        ctx.moveTo(cx, cy);
        ctx.arc(cx, cy, radio, angle, angle + arc);
        ctx.fill();

        ctx.save();
        ctx.translate(cx, cy);
        ctx.rotate(angle + arc / 2);
        ctx.textAlign = "right";
        ctx.fillStyle = "#fff";
        
        // Ajustar tama√±o de fuente seg√∫n la longitud del texto
        const fontSize = size / (todosPremios[i].texto.length > 30 ? 25 : 25);
        ctx.font = "bold " + fontSize + "px sans-serif";
        
        ctx.fillText(todosPremios[i].texto, radio - 10, 10);
        ctx.restore();
      }

      // Dibujar puntero
      ctx.beginPath();
      ctx.fillStyle = "#000";
      ctx.moveTo(cx, 10);
      ctx.lineTo(cx - 10, 30);
      ctx.lineTo(cx + 10, 30);
      ctx.fill();
    }

    function girarRuleta() {
      if (spinning) return;
      
      spinning = true;
      btnGirar.disabled = true;
      btnGirar.textContent = "Girando...";

      const segmentos = todosPremios.length;
      const anguloPorSegmento = 360 / segmentos;
      const vueltas = 4; // N√∫mero de vueltas completas
      
      // Elige un premio al azar (√≠ndice)
      const premioIndex = Math.floor(Math.random() * segmentos);
      
      // Calcula el √°ngulo final para que el premio quede en la parte superior
      const anguloFinal = -(premioIndex * anguloPorSegmento + anguloPorSegmento/2);
      
      // √Ångulo total a girar (vueltas completas + √°ngulo final)
      let angle = (vueltas * 360) + anguloFinal;
      
      let current = 0;
      let duration = 4000;
      const start = performance.now();

      function animate(time) {
        let elapsed = time - start;
        if (elapsed < duration) {
          current = easeOut(elapsed, 0, angle, duration);
          startAngle = (current * Math.PI / 180) % (2 * Math.PI);
          dibujarRuleta();
          requestAnimationFrame(animate);
        } else {
          spinning = false;
          btnGirar.disabled = false;
          btnGirar.textContent = "üéØ Girar la ruleta";
          
          premioObtenido = todosPremios[premioIndex]; // Asigna directamente el premio seleccionado
          mostrarResultado();
        }
      }

      requestAnimationFrame(animate);
    }

    function easeOut(t, b, c, d) {
      t /= d;
      t--;
      return c*(t*t*t + 1) + b;
    }

    function enviarFormulario() {
      const nombre = document.getElementById("nombre").value.trim();
      const telefono = document.getElementById("telefono").value.trim();

      if (!nombre || !telefono) {
        alert("Por favor, completa todos los campos requeridos.");
        return;
      }

      btnEnviar.disabled = true;
      btnEnviar.textContent = "Enviando...";

      window.datosUsuario = { nombre, telefono };
      
      // Simulamos un peque√±o retraso para mejor UX
      setTimeout(() => {
        document.getElementById("formulario").style.display = "none";
        document.getElementById("ruleta").style.display = "block";
        btnEnviar.disabled = false;
        btnEnviar.textContent = "Enviar y girar ruleta";
        dibujarRuleta();
      }, 800);
    }

    function mostrarResultado() {
      document.getElementById("ruleta").style.display = "none";
      
      // Validaci√≥n adicional para asegurar que premioObtenido existe
      if (!premioObtenido || !premioObtenido.texto) {
        premioObtenido = { 
          texto: "Premio no disponible", 
          descripcion: "Ocurri√≥ un error inesperado" 
        };
      }
      
      let mensaje = "";
      // Verifica si el premio est√° en los premios principales
      const esPremioPrincipal = premiosPrincipales.includes(premioObtenido);
      
      if (!esPremioPrincipal) {
        mensaje = `<div class="mensaje-resultado">
                     <h3>üòä Gracias por participar, ${window.datosUsuario.nombre}</h3>
                     <p class="premio-texto">${premioObtenido.texto}</p>
                     <p class="premio-descripcion">${premioObtenido.descripcion}</p>
                   </div>`;
      } else {
        mensaje = `<div class="mensaje-resultado">
                     <h3>üéâ ¬°Felicidades ${window.datosUsuario.nombre}!</h3>
                     <p class="premio-texto">${premioObtenido.texto}</p>
                     <p class="premio-descripcion">${premioObtenido.descripcion}</p>
                     <p class="contacto">Nos pondremos en contacto contigo pronto al n√∫mero ${window.datosUsuario.telefono}.</p>
                   </div>`;
      }
      
      document.getElementById("mensajeFinal").innerHTML = mensaje;
      document.getElementById("mensajeFinal").style.display = "block";

      // Enviar datos al servidor
      enviarDatosAlServidor();
    }

    function enviarDatosAlServidor() {
      const datos = {
        nombre: window.datosUsuario.nombre,
        telefono: window.datosUsuario.telefono,
        premio: premioObtenido.texto,
        descripcion: premioObtenido.descripcion || "",
        fecha: new Date().toISOString()
      };

      const params = new URLSearchParams();
      for (const key in datos) {
        params.append(key, datos[key]);
      }

      fetch("https://script.google.com/macros/s/AKfycbxJnyIoOgNQGrXudraKp9pt9QVcgxzEI6F3ga1uziAU_78BciNcxzyqRP2GzQi36TNM/exec", {
        method: "POST",
        headers: {
          "Content-Type": "application/x-www-form-urlencoded",
        },
        body: params,
        redirect: "follow"
      })
      .then(response => {
        if (!response.ok) throw new Error("Error en la respuesta del servidor");
        return response.json();
      })
      .then(data => {
        if (data.success) {
          console.log("Datos guardados correctamente");
        } else {
          console.error("Error del servidor:", data.error);
        }
      })
      .catch(err => {
        console.error("Error al enviar datos:", err);
      });
    }
</script>
</body>
</html>
